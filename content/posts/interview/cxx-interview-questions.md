---
title: "Cxx Interview Questions"
date: 2024-03-06T09:48:16+08:00
draft: true
summary: "C/Cxx常见面试问题"
---

## `new`与`malloc()`的区别

首先都是用来做堆内存分配的，但一个是C++提供的运算符一个是C标准库中提供的库函数。

就内存分配而言其实没有太多不同，甚至默认new的分配操作就是去调用`malloc`而已。

但`new`毕竟是C++提供的运算符，还具有其他的语义：

1. 自动计算需要分配的内存大小
2. 自动调用构造函数

这些特性由编译器实现。

## 线程局部变量如何实现的？

要解决的问题是：使用同样的地址（索引）Offset，如何访问到不同的值（每线程不同）？

直观的解决思路很简单，只需要每个线程有一个不同内存空间（起始地址Start自然不同）

然后只需要Start + Offset即可访问到不同值。

问题在于这个Start放在那里，如果使用一个全局变量来存，似乎其也是一个线程局部变量，变成了鸡生蛋蛋生鸡的问题了。

*使用段寄存器FS/GS破局*

Start地址，直接在内存存放多份（每线程对应一个，比如可以放在PCB/TCB里面），在执行时直接将其加载到FS中

> 实际FS存的是段描述符，实际的段基址放在类MSR寄存器中（FS/GS是特殊寄存器，不用去GDT中查找）

故现在访问线程局部变量直接使用FS:Offset即可。

段寄存器能生效的原因是，每个CPU都有自己的FS/GS寄存器，故多个线程同时执行时，可以指向不同的值。不像全局变量只有一份，所有线程访问到值都是一样。（并行时，也不能去改全局变量）
